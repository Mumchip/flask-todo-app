{% extends "base.html" %}

{% block content %}
<section class="add-task">
    <input type="text" id="new-task-input" placeholder="What needs to be done?" />
    <button id="add-task-button">Add Task</button>
</section>

<!-- Controls section for showing counts and filtering tasks -->
<section class="controls">
    <span id="task-count"></span>
    <div class="filters">
        <button data-filter="all" class="filter-button active">All</button>
        <button data-filter="active" class="filter-button">Active</button>
        <button data-filter="completed" class="filter-button">Completed</button>
    </div>
</section>

<ul id="task-list">
    {% for task in tasks %}
        <li data-id="{{ task.id }}" class="task {% if task.completed %}completed{% endif %}">
            <label>
                <input type="checkbox" class="toggle" {% if task.completed %}checked{% endif %} />
                <span class="title">{{ task.title }}</span>
            </label>
            <button class="edit" title="Edit">✎</button>
            <button class="delete" title="Delete">×</button>
        </li>
    {% endfor %}
</ul>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Track the current filter state
let currentFilter = 'all';

// Update the task count display
function updateCount() {
    const tasks = document.querySelectorAll('#task-list li');
    let active = 0;
    let completed = 0;
    tasks.forEach(li => {
        if (li.classList.contains('completed')) {
            completed++;
        } else {
            active++;
        }
    });
    const total = tasks.length;
    document.getElementById('task-count').textContent =
      `${active} active / ${completed} completed / ${total} total`;
}

// Apply the current filter to show/hide tasks
function applyFilter() {
    document.querySelectorAll('#task-list li').forEach(li => {
        const done = li.classList.contains('completed');
        if (currentFilter === 'active' && done) {
            li.style.display = 'none';
        } else if (currentFilter === 'completed' && !done) {
            li.style.display = 'none';
        } else {
            li.style.display = '';
        }
    });
}

// Add a new task via the API and update the list
document.getElementById('add-task-button').addEventListener('click', async () => {
    const input = document.getElementById('new-task-input');
    const title = input.value.trim();
    if (!title) return;
    const response = await fetch('/api/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title })
    });
    if (response.ok) {
        const task = await response.json();
        appendTask(task);
        input.value = '';
    }
});

// Create a list item element for a task and prepend to the list
function appendTask(task) {
    const list = document.getElementById('task-list');
    const li = document.createElement('li');
    li.setAttribute('data-id', task.id);
    li.className = 'task' + (task.completed ? ' completed' : '');
    li.innerHTML = `
        <label>
            <input type="checkbox" class="toggle" ${task.completed ? 'checked' : ''} />
            <span class="title"></span>
        </label>
        <button class="edit" title="Edit">✎</button>
        <button class="delete" title="Delete">×</button>
    `;
    li.querySelector('.title').textContent = task.title;
    bindTaskEvents(li);
    list.insertBefore(li, list.firstChild);
    updateCount();
    applyFilter();
}

// Bind events for toggling, deleting and editing on a task element
function bindTaskEvents(li) {
    const checkbox = li.querySelector('.toggle');
    checkbox.addEventListener('change', async () => {
        const id = li.getAttribute('data-id');
        const completed = checkbox.checked;
        const response = await fetch(`/api/tasks/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ completed })
        });
        if (response.ok) {
            li.classList.toggle('completed', completed);
            updateCount();
            applyFilter();
        }
    });

    const deleteBtn = li.querySelector('.delete');
    deleteBtn.addEventListener('click', async () => {
        const id = li.getAttribute('data-id');
        const response = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
        if (response.ok) {
            li.remove();
            updateCount();
            applyFilter();
        }
    });

    const editBtn = li.querySelector('.edit');
    editBtn.addEventListener('click', async () => {
        const id = li.getAttribute('data-id');
        const titleSpan = li.querySelector('.title');
        const current = titleSpan.textContent;
        const newTitle = prompt('Edit task', current);
        if (newTitle !== null) {
            const trimmed = newTitle.trim();
            if (!trimmed) return;
            const resp = await fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title: trimmed })
            });
            if (resp.ok) {
                const updated = await resp.json();
                titleSpan.textContent = updated.title;
            }
        }
    });
}

// Bind events to existing tasks on page load
document.querySelectorAll('#task-list li').forEach(li => bindTaskEvents(li));

// Bind events to filter buttons
document.querySelectorAll('.filter-button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        applyFilter();
    });
});

// Initialize counts on page load
updateCount();
</script>
{% endblock %}
